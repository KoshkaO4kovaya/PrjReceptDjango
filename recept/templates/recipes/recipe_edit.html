{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<section class="max-w-5xl mx-auto p-4 sm:p-6 bg-gray-50 min-h-screen">
    <div class="p-6 bg-white rounded-xl shadow-2xl shadow-gray-200 mt-8 mb-12 border border-gray-100">

        <div class="mb-8 border-b border-gray-200 pb-6">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">
                {% if recipe %}
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞: <span class="text-green-600">{{ recipe.title }}</span>
                {% else %}
                    –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞ üöÄ
                {% endif %}
            </h1>
            {% if recipe %}
                <p class="text-sm text-gray-500 mt-2 flex items-center space-x-2">
                    <span>–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:</span>
                    <span class="font-semibold px-3 py-1 rounded-full text-xs transition duration-150
                        {% if recipe.status == 'draft' %}bg-orange-100 text-orange-600 ring-1 ring-orange-200{% else %}bg-green-100 text-green-600 ring-1 ring-green-200{% endif %}">
                        {{ recipe.get_status_display }}
                    </span>
                </p>
            {% endif %}
        </div>

        {% if messages %}
            <div class="mb-6 space-y-3">
                {% for message in messages %}
                    <div class="p-4 rounded-lg text-sm border
                        {% if message.tags == 'success' %}bg-green-50 text-green-800 border-green-200{% else %}bg-red-50 text-red-800 border-red-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        {% if form.errors or ingredient_formset.errors or formset.errors %}
        <div class="mb-6 p-4 rounded-lg bg-red-50 border border-red-200 text-red-800 text-sm font-medium">
            <p class="font-bold mb-2">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã:</p>
            {% if form.errors %}<p>- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>{% endif %}
            {% if ingredient_formset.errors %}<p>- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</p>{% endif %}
            {% if formset.errors %}<p>- –≠—Ç–∞–ø—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</p>{% endif %}
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="space-y-10" id="recipe-form">
            {% csrf_token %}
            {{ form.status_field }}

            <div class="p-6 border border-gray-200 rounded-xl shadow-md bg-white">
                <h2 class="text-2xl font-bold mb-6 text-green-600 border-b border-gray-100 pb-3">1. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.title.label }} <span class="text-red-500">*</span></label>
                        {{ form.title|add_class:"mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 text-base h-10" }}
                        {% for error in form.title.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                    </div>
                    
                    <div>
                        <label for="{{ form.cover_image.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.cover_image.label }}</label>
                        <div class="mt-1 flex items-center space-x-4">
                            {% if recipe.cover_image %}
                                <img src="{{ recipe.cover_image.url }}" alt="–û–±–ª–æ–∂–∫–∞" class="h-12 w-12 rounded-lg object-cover border border-gray-200 shadow-sm">
                                <span class="text-sm text-gray-500 truncate">–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª: {{ recipe.cover_image.name|truncatechars:20 }}</span>
                            {% else %}
                                <div class="h-12 w-12 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400">üñºÔ∏è</div>
                            {% endif %}
                            {{ form.cover_image|add_class:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" }}
                        </div>
                        {% for error in form.cover_image.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                    </div>
                </div>
                
                <div class="mt-6">
                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.description.label }} <span class="text-red-500">*</span></label>
                    {{ form.description|add_class:"mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 text-sm" }}
                    {% for error in form.description.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mt-6">
                    {% for field in recipe_details_fields %}
                        <div>
                            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ field.label }} <span class="text-red-500">*</span></label>
                            {{ field|add_class:"mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 text-sm h-10" }}
                            {% for error in field.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                        </div>
                    {% endfor %}
                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700">{{ form.genres.label }} <span class="text-red-500">*</span></label>
                    <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        {{ form.genres }}
                    </div>
                    {% for error in form.genres.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                </div>
                
                <div class="mt-6">
                    <label for="{{ form.video_file.id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.video_file.label }}</label>
                    <div class="mt-1 flex items-center space-x-3">
                        {% if recipe.video_file %}
                            <p class="text-sm text-gray-500">–¢–µ–∫—É—â–∏–π –≤–∏–¥–µ–æ—Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω.</p>
                        {% endif %}
                        {{ form.video_file|add_class:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" }}
                    </div>
                    {% for error in form.video_file.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                </div>
                
            </div>
            
            <div class="p-6 border border-gray-200 rounded-xl shadow-md bg-white">
                <h2 class="text-2xl font-bold mb-6 text-green-600 border-b border-gray-100 pb-3">2. –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h2>
                
                {{ ingredient_formset.management_form }}
                
                <div id="ingredient-forms-container" class="space-y-4">
                    {% for ingr_form in ingredient_formset %}
                    <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0 items-end p-4 border border-gray-100 rounded-lg bg-gray-50 ingredient-form-row">
                        {% if ingr_form.DELETE %}{{ ingr_form.DELETE }}{% endif %}
                        
                        <div class="flex-grow w-full">
                            <label for="{{ ingr_form.ingredient_name.id_for_label }}" class="block text-xs font-medium text-gray-500 mb-1">{{ ingr_form.ingredient_name.label }}</label>
                            {{ ingr_form.ingredient_name|add_class:"w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm h-9" }}
                            {% for error in ingr_form.ingredient_name.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                        </div>
                        <div class="w-full sm:w-1/5">
                            <label for="{{ ingr_form.quantity.id_for_label }}" class="block text-xs font-medium text-gray-500 mb-1">{{ ingr_form.quantity.label }}</label>
                            {{ ingr_form.quantity|add_class:"w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm h-9" }}
                            {% for error in ingr_form.quantity.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                        </div>
                        <div class="w-full sm:w-1/5">
                            <label for="{{ ingr_form.unit.id_for_label }}" class="block text-xs font-medium text-gray-500 mb-1">{{ ingr_form.unit.label }}</label>
                            {{ ingr_form.unit|add_class:"w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm h-9" }}
                            {% for error in ingr_form.unit.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                        </div>
                        <button type="button" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-150 remove-ingredient-row flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>
                
                <button type="button" id="add-ingredient-btn" class="mt-4 text-blue-600 hover:text-blue-700 text-sm font-semibold flex items-center transition duration-150 p-2 rounded-lg hover:bg-blue-50">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                </button>
                
            </div>
            
            <div class="p-6 border border-gray-200 rounded-xl shadow-md bg-white">
                <h2 class="text-2xl font-bold mb-6 text-green-600 border-b border-gray-100 pb-3">3. –≠—Ç–∞–ø—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</h2>
                
                {{ formset.management_form }}
                
                <div id="step-forms-container" class="space-y-6">
                    {% for step_form in formset %}
                    <div class="p-5 border border-gray-200 rounded-xl step-form-row relative bg-white shadow-sm">
                        
                        <div class="flex items-center justify-between mb-3 border-b pb-2">
                            <h4 class="text-lg font-bold text-gray-700 flex items-center space-x-2">
                                <span class="w-6 h-6 flex items-center justify-center bg-blue-500 text-white rounded-full text-xs font-mono step-order">{{ forloop.counter }}</span>
                                <span>–≠—Ç–∞–ø –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</span>
                            </h4>
                            <button type="button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs remove-step-row transition duration-150">
                                <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                        
                        {% if step_form.DELETE %}{{ step_form.DELETE }}{% endif %}
                        {% for hidden in step_form.hidden_fields %}{{ hidden }}{% endfor %}
                        
                        <div>
                            <label for="{{ step_form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            {{ step_form.description|add_class:"w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" }}
                            {% for error in step_form.description.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                        </div>
                        
                        <div class="mt-4">
                            <label for="{{ step_form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                            <div class="flex items-center space-x-4 mt-1">
                                {% if step_form.instance.image %}
                                    <img src="{{ step_form.instance.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç—Ç–∞–ø–∞" class="h-12 w-12 rounded-lg object-cover border border-gray-200 shadow-sm">
                                    <span class="text-sm text-gray-500">–¢–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</span>
                                {% else %}
                                    <div class="h-12 w-12 rounded-lg bg-gray-100 flex items-center justify-center text-gray-400">üì∏</div>
                                {% endif %}
                                {{ step_form.image|add_class:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" }}
                            </div>
                            {% for error in step_form.image.errors %}<p class="text-red-500 text-xs italic mt-1">{{ error }}</p>{% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <button type="button" id="add-step-btn" class="mt-6 text-blue-600 hover:text-blue-700 text-sm font-semibold flex items-center transition duration-150 p-2 rounded-lg hover:bg-blue-50">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∞–ø
                </button>
                
            </div>
         <input type="hidden" name="submit_status" id="submit_status_input" value="{% if recipe %}{{ recipe.status }}{% else %}draft{% endif %}">
    
    <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
        
        <button type="submit" 
                onclick="document.getElementById('submit_status_input').value='draft'" 
                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150">
            <i class="fas fa-save mr-2"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫
        </button>
        
        <button type="submit" 
                onclick="document.getElementById('submit_status_input').value='pending'" 
                class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-150 shadow-lg shadow-green-200/50">
            <i class="fas fa-upload mr-2"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é
        </button>
    </div>

</form>
        
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- –®–∞–±–ª–æ–Ω—ã –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–æ—Ä–º ---
        
        // –®–∞–±–ª–æ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–û: –∑–∞–º–µ–Ω–µ–Ω—ã ' –Ω–∞ ` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–Ω—ã—Ö –ª–∏—Ç–µ—Ä–∞–ª–æ–≤
        const emptyIngredientForm = `
            <div class="flex flex-col sm:flex-row sm:space-x-3 space-y-3 sm:space-y-0 items-end p-4 border border-gray-100 rounded-lg bg-gray-50 ingredient-form-row">
                <input type="hidden" name="ingr-__prefix__-DELETE" id="id_ingr-__prefix__-DELETE">
                <div class="flex-grow w-full">
                    <label for="id_ingr-__prefix__-ingredient_name" class="block text-xs font-medium text-gray-500 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞</label>
                    <input type="text" name="ingr-__prefix__-ingredient_name" id="id_ingr-__prefix__-ingredient_name" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm h-9">
                </div>
                <div class="w-full sm:w-1/5">
                    <label for="id_ingr-__prefix__-quantity" class="block text-xs font-medium text-gray-500 mb-1">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" step="0.01" name="ingr-__prefix__-quantity" id="id_ingr-__prefix__-quantity" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm h-9">
                </div>
                <div class="w-full sm:w-1/5">
                    <label for="id_ingr-__prefix__-unit" class="block text-xs font-medium text-gray-500 mb-1">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                    <select name="ingr-__prefix__-unit" id="id_ingr-__prefix__-unit" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm h-9">
                        <option value="g">–ì—Ä–∞–º–º—ã</option>
                        <option value="ml">–ú–∏–ª–ª–∏–ª–∏—Ç—Ä—ã</option>
                        <option value="pcs">–®—Ç—É–∫–∏</option>
                        <option value="teasp">–ß–∞–π–Ω–∞—è –ª–æ–∂–∫–∞</option>
                        <option value="tablesp">–°—Ç–æ–ª–æ–≤–∞—è –ª–æ–∂–∫–∞</option>
                        <option value="kg">–ö–∏–ª–æ–≥—Ä–∞–º–º—ã</option>
                        <option value="cup">–ö—Ä—É–∂–∫–∞</option>
                    </select>
                </div>
                <button type="button" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg text-sm transition duration-150 remove-ingredient-row flex-shrink-0">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        `;

        // –®–∞–±–ª–æ–Ω –¥–ª—è –Ω–æ–≤–æ–≥–æ —ç—Ç–∞–ø–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–û: –∑–∞–º–µ–Ω–µ–Ω—ã ' –Ω–∞ ` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–Ω—ã—Ö –ª–∏—Ç–µ—Ä–∞–ª–æ–≤
        const emptyStepForm = `
            <div class="p-5 border border-gray-200 rounded-xl step-form-row relative bg-white shadow-sm">
                
                <div class="flex items-center justify-between mb-3 border-b pb-2">
                    <h4 class="text-lg font-bold text-gray-700 flex items-center space-x-2">
                        <span class="w-6 h-6 flex items-center justify-center bg-blue-500 text-white rounded-full text-xs font-mono step-order">__step_order__</span>
                        <span>–≠—Ç–∞–ø –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</span>
                    </h4>
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs remove-step-row transition duration-150">
                        <svg class="w-3 h-3 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>

                <input type="hidden" name="form-__prefix__-id" id="id_form-__prefix__-id">
                <input type="hidden" name="form-__prefix__-order" id="id_form-__prefix__-order" value="__step_order__">
                <input type="hidden" name="form-__prefix__-DELETE" id="id_form-__prefix__-DELETE">
                
                <div>
                    <label for="id_form-__prefix__-description" class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea name="form-__prefix__-description" id="id_form-__prefix__-description" rows="2" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"></textarea>
                </div>
                
                <div class="mt-4">
                    <label for="id_form-__prefix__-image" class="block text-sm font-medium text-gray-700 mb-1">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                    <input type="file" name="form-__prefix__-image" accept="image/*" id="id_form-__prefix__-image" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
            </div>
        `;


        // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ñ–æ—Ä–º—ã –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ ---
        const ingredientContainer = document.getElementById('ingredient-forms-container');
        const addIngredientButton = document.getElementById('add-ingredient-btn');
        const totalIngredientForms = document.getElementById('id_ingr-TOTAL_FORMS');

        function updateIngredientIndices() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Array.from –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            Array.from(ingredientContainer.querySelectorAll('.ingredient-form-row')).forEach((row, index) => {
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–∫—Ä—ã—Ç–∞ (–ø–æ–º–µ—á–µ–Ω–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—ë
                if (row.style.display === 'none') return; 

                row.querySelectorAll('[name]').forEach(input => {
                    input.name = input.name.replace(/ingr-\d+/, `ingr-${index}`);
                    input.id = input.id.replace(/ingr-\d+/, `ingr-${index}`);
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ for —É label
                    const label = row.querySelector(`[for="${input.id.replace(/ingr-\d+/, `ingr-${index-1}`)}"]`);
                    if (label) {
                        label.setAttribute('for', input.id);
                    }
                });
            });
        }
        
        function addIngredientForm(e) {
            e.preventDefault();
            let currentForms = parseInt(totalIngredientForms.value);
            const newFormHtml = emptyIngredientForm.replace(/__prefix__/g, currentForms);
            
            const newDiv = document.createElement('div');
            newDiv.innerHTML = newFormHtml.trim();
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
            ingredientContainer.appendChild(newDiv.firstChild);
            totalIngredientForms.value = currentForms + 1;
            updateIngredientIndices(); 
        }

        function deleteIngredientForm(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–∂–∞—Ç–∞ –∏–º–µ–Ω–Ω–æ –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å –∏–∫–æ–Ω–∫–æ–π
            if (!e.target.closest('.remove-ingredient-row')) return;
            e.preventDefault();
            
            const row = e.target.closest('.ingredient-form-row');
            
            // –ù–∞—Ö–æ–¥–∏–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ DELETE
            const deleteInput = row.querySelector(`[id$="-DELETE"]`);
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ DELETE, —ç—Ç–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–ª–∏ –Ω–æ–≤—ã–π-–≤-—Ñ–æ—Ä–º–µ—Å–µ—Ç –æ–±—ä–µ–∫—Ç
            if (deleteInput) {
                // –ï—Å–ª–∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å ID (—Ç.–µ. —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ë–î), –ø–æ–º–µ—á–∞–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º
                const idInput = row.querySelector(`[id$="-id"]`);
                if (idInput && idInput.value) { 
                    deleteInput.checked = true;
                    row.style.display = 'none'; 
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç ID (—Ç.–µ. —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏), —É–¥–∞–ª—è–µ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏
                    row.remove(); 
                    // –£–º–µ–Ω—å—à–∞–µ–º TOTAL_FORMS, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "–ø—Ä–æ–ø—É—Å–∫–æ–≤" –≤ –Ω—É–º–µ—Ä–∞—Ü–∏–∏
                    let currentForms = parseInt(totalIngredientForms.value);
                    totalIngredientForms.value = currentForms - 1; 
                }
            } else {
               // Fallback: –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º
               row.remove();
            }

            updateIngredientIndices(); // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è
        }


        addIngredientButton.addEventListener('click', addIngredientForm);
        ingredientContainer.addEventListener('click', deleteIngredientForm);


        // --- –õ–æ–≥–∏–∫–∞ –¥–ª—è —Ñ–æ—Ä–º—ã –≠—Ç–∞–ø–æ–≤ ---
        const stepContainer = document.getElementById('step-forms-container');
        const addStepButton = document.getElementById('add-step-btn');
        const totalStepForms = document.getElementById('id_form-TOTAL_FORMS'); 

        function getVisibleStepRows() {
             // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ç–µ —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–µ
            return Array.from(stepContainer.querySelectorAll('.step-form-row')).filter(row => {
                const deleteInput = row.querySelector('[id$="-DELETE"]');
                return row.style.display !== 'none' && (!deleteInput || !deleteInput.checked);
            });
        }

        function updateStepIndices() {
            let visibleRows = getVisibleStepRows();
            let actualVisibleIndex = 1;

            Array.from(stepContainer.querySelectorAll('.step-form-row')).forEach((row) => {
                const deleteInput = row.querySelector('[id$="-DELETE"]');
                const isMarkedForDeletion = deleteInput && deleteInput.checked;

                if (!isMarkedForDeletion && row.style.display !== 'none') {
                    const stepOrderElement = row.querySelector('.step-order');
                    if (stepOrderElement) {
                         stepOrderElement.textContent = actualVisibleIndex; 
                    }
                    
                    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ñ–æ—Ä–º—ã –≤ —Ñ–æ—Ä–º—Å–µ—Ç–µ (–Ω–µ–≤–∏–¥–∏–º—ã–π –∏–Ω–¥–µ–∫—Å)
                    let formsetIndexMatch = Array.from(stepContainer.querySelectorAll('.step-form-row')).indexOf(row);

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ name/id
                    row.querySelectorAll('[name]').forEach(input => {
                        input.name = input.name.replace(/form-\d+/, `form-${formsetIndexMatch}`);
                        input.id = input.id.replace(/form-\d+/, `form-${formsetIndexMatch}`);
                         // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞ for —É label
                        const label = row.querySelector(`[for="${input.id.replace(/form-\d+/, `form-${formsetIndexMatch}`)}"]`);
                        if (label) {
                            label.setAttribute('for', input.id);
                        }
                    });
            
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è order (–¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞)
                    const orderInput = row.querySelector(`[name$="-order"]`);
                    if (orderInput) {
                        orderInput.value = actualVisibleIndex;
                    }
                    actualVisibleIndex++;
                }
            });
        }
        
        function addStepForm(e) {
            e.preventDefault();
            let currentForms = parseInt(totalStepForms.value);
            let nextStepOrder = getVisibleStepRows().length + 1; 
            
            let newFormHtml = emptyStepForm.replace(/__prefix__/g, currentForms);
            newFormHtml = newFormHtml.replace(/__step_order__/g, nextStepOrder);
            
            const newDiv = document.createElement('div');
            newDiv.innerHTML = newFormHtml.trim();

            stepContainer.appendChild(newDiv.firstChild);
            totalStepForms.value = currentForms + 1;
            updateStepIndices(); 
        }

        function deleteStepForm(e) {
            if (!e.target.closest('.remove-step-row')) return;
            e.preventDefault();
            
            const row = e.target.closest('.step-form-row');
            
            const deleteInput = row.querySelector(`[id$="-DELETE"]`);
            const idInput = row.querySelector(`[id$="-id"]`);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —Ñ–æ—Ä–º—ã ID. –ï—Å–ª–∏ –µ—Å—Ç—å, —ç—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç.
            if (idInput && idInput.value) { 
                // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç: –ø–æ–º–µ—á–∞–µ–º –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∏ —Å–∫—Ä—ã–≤–∞–µ–º
                if (deleteInput) {
                    deleteInput.checked = true;
                    row.style.display = 'none'; 
                }
            } else {
                // –ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç: —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º 
                row.remove(); 
                let currentForms = parseInt(totalStepForms.value);
                // –í–ê–ñ–ù–û: TOTAL_FORMS —É–º–µ–Ω—å—à–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–æ—Ä–º—ã –∏–∑ –î–û–ú
                // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ —É–¥–∞–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ —á–µ–∫–±–æ–∫—Å DELETE, TOTAL_FORMS –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º.
                totalStepForms.value = currentForms - 1; 
            }
            
            updateStepIndices(); 
        }

        addStepButton.addEventListener('click', addStepForm);
        stepContainer.addEventListener('click', deleteStepForm);
        
        // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫, –µ—Å–ª–∏ —Ñ–æ—Ä–º—ã —É–∂–µ –µ—Å—Ç—å
        updateStepIndices();
    });
</script>
{% endblock %}